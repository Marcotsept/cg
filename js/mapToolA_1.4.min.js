function readFile(e){var t,n="",r=new FileReader;r.readAsArrayBuffer(e);r.onload=function(i){t=new DataView(r.result);n+=String.fromCharCode(t.getUint8(0));n+=String.fromCharCode(t.getUint8(1));n+=String.fromCharCode(t.getUint8(2));if(n=="MAP"){$("#filename").html(e.name).removeClass("label-default").addClass("label-success");parseResult(t)}else{e=undefined;$("#map_size").add("#map_content").html("");$("#filename").html("xxxx.dat").removeClass("label-success").addClass("label-default")}}}function parseResult(e){var t={};var n;var r=[];var i;var s;var o,u;var a="";t.width=e.getUint16(12,true);t.height=e.getUint16(16,true);t.area=t.width*t.height;t.toString=function(){var e=searchTarget==3?"迷宮":"地圖";e+="大小 : "+this.width+"&times;"+this.height;return e};$("#map_size").html(t.toString());n=t.area*2;r=[];if(isFullSearch){sRange.e1=t.width;sRange.s1=t.height}for(var f=sRange.s0;f<sRange.s1;f++){for(var l=sRange.e0;l<sRange.e1;l++){o=(l+f*t.width)*2+n*2+20;u=o-n;i=e.getUint16(o,true)%256;if(i==searchTarget){s=e.getUint16(u,true);r.push({east:l,south:f,pnum:getStairPic(s)})}}}if(!isFullSearch)a="在東("+sRange.e0+"~"+sRange.e1+"),南("+sRange.s0+"~"+sRange.s1+")範圍內<br/>";else a="";if(r.length==0){a+=searchTarget==3?"沒找到任何樓梯位置":"沒找到任何出入口位置";$("#map_content").html(a)}else{a+='<table class="table table-striped">';a+='<caption> 共找到 <span class="badge">'+r.length+"</span>個";a+=searchTarget==3?"樓梯位置":"地圖出入口";a+="</caption>";for(var f=0;f<r.length;f++){a+="<tr><td>";a+='<span class="badge">'+(r[f].east+","+r[f].south)+"</span>";a+='<img src="images/stair/s00'+r[f].pnum+'.gif" />';a+="</td></tr>"}a+="</table>";$("#map_content").html(a)}}function getStairPic(e){var t="";for(var n=0;n<st.length;n++){if(e==st[n].gnum){t=st[n].pnum;break}}return t}var searchTarget=3,isFullSearch=true,sRange={e0:0,e1:1e3,s0:0,s1:1e3};jQuery.event.props.push("dataTransfer");$(document).ready(function(){var e;$("#searchType").click(function(t){searchTarget=$(t.target).find(":radio").val();if(e!=undefined)readFile(e)});$("#fullSearch").click(function(t){isFullSearch=true;sRange.e0=0;sRange.s0=0;if(e!=undefined)readFile(e)});$("#rangeSearch").click(function(e){isFullSearch=false});$("#saveRange").click(function(t){var n=$("#e0").val(),r=$("#e1").val(),i=$("#s0").val(),s=$("#s1").val();n=Math.max(0,n);r=Math.max(0,r);i=Math.max(0,i);s=Math.max(0,s);sRange.e0=Math.min(n,r);sRange.e1=Math.max(n,r);sRange.s0=Math.min(i,s);sRange.s1=Math.max(i,s);if(e!=undefined)readFile(e)});$("#drop").on("dragover",function(e){e.stopPropagation();e.preventDefault()});$("#drop").on("drop",function(t){t.stopPropagation();t.preventDefault();e=t.originalEvent.dataTransfer.files[0];if(e.name.split(".")[1]=="dat")readFile(e)})})