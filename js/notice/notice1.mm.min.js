function findMaterial(e){var t;for(var n=0;n<materials.length;n++)if(materials[n].code==e){t=materials[n];break}return t}function clearTable(){for(var e=1;e<=5;e++){$("#mt"+e).html("&nbsp;");$("#set"+e).html("&nbsp;")}}function fillMaterial(e){var t;for(var n=1;n<=5;n++){t=findMaterial(e["mt"+n]);if(t){$("#mt"+n).html(t.name+" x "+e["qty"+n]);$("#set"+n).html(t.set+" pcs/組");useMts.push(t)}}}function setProduct(){useMts=[];product=recipe[$("#type").val()][$("#product").val()];fillMaterial(product)}function genEqpList(e){var t=recipe[e];$("#product").removeOption(/./);for(var n=0;n<t.length;n++)$("#product").addOption(n,"Lv."+t[n].level+" "+t[n].name);$("#product").val(0).find("option").each(function(){var e=0;var t=$.trim($(this).text().substring(3,5));e=parseInt(t);if(e%2!=0){$(this).css({"background-color":"#333",color:"#FFFF33"})}}).css("border","dashed 1px #808080");setProduct()}var types=[{val:"wp01",name:"劍"},{val:"wp02",name:"斧"},{val:"wp03",name:"槍"},{val:"wp04",name:"弓"},{val:"wp05",name:"杖"},{val:"wp06",name:"小刀"},{val:"wp07",name:"回力鏢"},{val:"wp08",name:"炸彈"},{val:"sh01",name:"頭盔"},{val:"sh02",name:"帽子"},{val:"sh03",name:"鎧甲"},{val:"sh04",name:"衣服"},{val:"sh05",name:"袍"},{val:"sh06",name:"靴"},{val:"sh07",name:"鞋子"},{val:"sh08",name:"盾"},{val:"md01",name:"藥水"},{val:"fd01",name:"料理"}];var product;var useMts=[];var readyToSave=false,orderItem;$(function(){for(var e=0;e<types.length;e++)$("#type").addOption(types[e].val,types[e].name);$("#resultTable1").add("#resultTable2").find("div").css("font-family","Verdana");$("#type").val("wp01").find("option").slice(0,8).css("background-color","#708090").end().slice(8,16).css("background-color","#80A0C0").end().slice(16,18).css("background-color","#90C0F0");genEqpList($("#type").val());noticeBoard.init();$("#type").change(function(){var e=$(this).selectedOptions().first().index();var t;clearTable();useMts=[];t=function(){if(e>=8)return e>=16?"#90C0F0":"80A0C0";else return"#708090"}();$(this).add("#product").css("background-color",t);$("#result").html("");genEqpList($(this).val())});$("#product").change(function(){clearTable();setProduct();$("#resultTable1").add("#resultTable2").add("#errMessage").hide()});$("#slots").keydown(function(e){if(e.which==13)$("#calc").click()});$(".sbtn").click(function(){if(readyToSave){noticeBoard.save(orderItem)}else console.log("Not Ready To Save...")});$(".close").on("click",function(){var e=parseInt($(this).data("nid"),10);div=$(this).closest("div");noticeBoard.delete(e,div)});$("#noticeBoard").on("click",".mt-item",function(){noticeBoard.mark(this)});$("#calc").click(function(){var e=0;var t="";var n;var r,i;var s=new Date;var o;var u=$("#type").val();var a=$("input[name=method]:checked").val();$("#resultTable1, #resultTable2, #errMessage").hide();orderItem={id:noticeBoard.orderItems.idSeed++,qty:0,product:product.name,mts:[]};readyToSave=false;if(a=="method1"){var f=0;var l=parseInt($("#slots").val());if(useMts.length<=l){while(e<=l){f++;e=0;for(var c=0;c<useMts.length;c++){e+=Math.ceil(product["qty"+(c+1)]*f/useMts[c].set)}}f--;$("#pname1").html(product.name);for(var c=0;c<5;c++){n=c+1;if(c<useMts.length){o=product["qty"+n]*f;r=(new String(Math.floor(o/useMts[c].set))).fontcolor("blue")+" 組";if(o%useMts[c].set!=0)r+="又 "+(new String(o%useMts[c].set)).fontcolor("blue")+" 個";$("#p1mt"+n).html(useMts[c].name);$("#p1slt"+n).html(r);orderItem.mts.push(useMts[c].name+" "+r)}else{$("#p1mt"+n).html("&nbsp;");$("#p1slt"+n).html("&nbsp;");orderItem.mts.push("&nbsp;")}}if(u=="wp08"){r=(new String(f)).fontcolor("red")+" 次 / 共 ";r+=(new String(f*product.pcs)).fontcolor("blue")+" 個 ";orderItem.qty=f*product.pcs}else{r=(new String(f)).fontcolor("red")+" 個 ";orderItem.qty=f}$("#pqty1").html(r);$("#resultTable1").show();readyToSave=true}else{$("#errMessage").html("可使用格數不足！！").show()}}else{var h=parseInt($("#slots").val());if(u=="wp08"){h=Math.floor(h/product.pcs)}orderItem.qty=h;$("#pname2").html(product.name);$("#pqty2").html((new String(h)).fontcolor("red"));for(var c=0;c<5;c++){n=c+1;if(c<useMts.length){o=product["qty"+n]*h;e+=Math.ceil(o/useMts[c].set);$("#p2mt"+n).html(useMts[c].name);r=(new String(Math.floor(o/useMts[c].set))).fontcolor("blue")+" 組";if(o%useMts[c].set!=0)r+="又 "+(new String(o%useMts[c].set)).fontcolor("blue")+" 個";$("#p2slt"+n).html(r);orderItem.mts.push(useMts[c].name+" "+r)}else{$("#p2mt"+n).html("&nbsp;");$("#p2slt"+n).html("&nbsp;");orderItem.mts.push("&nbsp;")}}$("#p2uslt").html((new String(e)).fontcolor("red")+" 格");$("#resultTable2").show();readyToSave=h!=0}})});var noticeBoard={orderItems:{},init:function(){var e=localStorage.getItem("orderItems");if(e!==null){noticeBoard.orderItems=JSON.parse(e);noticeBoard.show()}else{noticeBoard.orderItems.idSeed=0;noticeBoard.orderItems.items=[]}},save:function(e){var t=noticeBoard.orderItems,n=["u","u","u","u","u"];e.m=n;t.items.push(e);noticeBoard.update(t);noticeBoard.showNotice(e,0)},"delete":function(e,t){var n=noticeBoard.orderItems,r=n.items,i=noticeBoard.getIndex(e);if(i!=-1){r.splice(i,1);t.fadeOut(1e3,function(){this.remove()});noticeBoard.update(n)}},update:function(e){localStorage.setItem("orderItems",JSON.stringify(e))},mark:function(e){var t=$(e),n=t.data("m"),r=t.closest(".notice"),i=parseInt(r.find(".close").data("nid"),10),s=noticeBoard.orderItems,o=s.items,u=noticeBoard.getIndex(i),a;if(u!=-1){a=o[u].m[n];if(a==="m"){a="u";t.css("text-decoration","none")}else{a="m";t.css("text-decoration","line-through")}o[u].m[n]=a;noticeBoard.update(s)}},getIndex:function(e){var t=noticeBoard.orderItems,n=t.items,r=-1;for(var i=0;i<n.length;i++){if(e==n[i].id)r=i}return r},showNotice:function(e,t){var n=$("#noticeTemplate").clone(true),r=600,i=[];n.removeClass("template").removeAttr("id").find(".close").data("nid",e.id).end().find("h3").html(e.product+(" X "+e.qty).fontcolor("#822")).end().hide().appendTo("#noticeBoard").delay(r*t).fadeIn(r);i=n.find(".mt-item");$.each(i,function(t,n){$(n).html(e.mts[t]).data("m",t);if(e.m[t]=="m")$(n).addClass("marked")})},show:function(){var e=localStorage.getItem("orderItems"),t=JSON.parse(e),n=t.items;$("#noticeBoard").html("");for(var r=0;r<n.length;r++){noticeBoard.showNotice(n[r],r)}}}